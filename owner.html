<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QTable | ì‚¬ì¥ë‹˜ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/dashboard.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .owner-dashboard {
            position: static;
            height: 100vh;
            background: #1a1a2e;
        }

        .dashboard-content {
            height: 100%;
            overflow-y: auto;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #FF6B35 0%, #E55A2B 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(120%);
            transition: transform 0.4s ease-out;
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        .order-list {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid #FF6B35;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }

        .ai-insight-box {
            margin-top: 12px;
            background: rgba(108, 99, 255, 0.15);
            border: 1px solid #6C63FF;
            border-radius: 8px;
            padding: 10px;
            font-size: 0.85rem;
            color: #E0E0FF;
            display: flex;
            gap: 8px;
            align-items: start;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .order-items {
            color: white;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-price {
            color: #FF6B35;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            padding: 40px 0;
        }

        .link-home {
            position: absolute;
            top: 16px;
            left: 16px;
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
            z-index: 1000;
        }

        .user-tag {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #aaa;
            margin-left: 8px;
        }

        /* QR Modal */
        #qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .qr-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            color: #333;
            max-width: 320px;
            animation: popIn 0.3s ease;
        }

        .qr-card h3 {
            margin-top: 0;
            color: #333;
        }

        .hidden {
            display: none;
        }

        .table-btn-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .table-btn {
            padding: 8px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .table-btn.active {
            background: #FF6B35;
            color: white;
            border-color: #FF6B35;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <a href="index.html" class="link-home">â† í™ˆìœ¼ë¡œ</a>
    <div class="owner-dashboard">
        <div class="dashboard-header">
            <h2 style="margin-left: 30px;">ğŸ“Š ì‹¤ì‹œê°„ ì£¼ë¬¸ ì ‘ìˆ˜ í˜„í™©</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="showQrModal()"
                    style="background:#fff; color:#333; border:none; padding:6px 12px; border-radius:20px; font-weight:bold; cursor:pointer;">ğŸ“±
                    í…Œì´ë¸” QR ì„¤ì •</button>
                <span class="preview-badge" style="background:var(--success)">LIVE</span>
            </div>
        </div>

        <div class="dashboard-content">
            <!-- ì‹¤ì‹œê°„ ì£¼ë¬¸ ëª©ë¡ -->
            <div class="dashboard-card">
                <h3>ğŸ”” ë“¤ì–´ì˜¨ ì£¼ë¬¸</h3>
                <div id="order-list" class="order-list">
                    <div class="empty-state">
                        <p>ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <p style="font-size:0.8rem; margin-top:8px;">í…Œì´ë¸” QRë¡œ ì£¼ë¬¸ì´ ë“¤ì–´ì˜¤ë©´<br>ì—¬ê¸°ì— í…Œì´ë¸” ë²ˆí˜¸ì™€ í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-card ai-card">
                <div class="ai-header">
                    <span class="ai-icon">ğŸ¤–</span>
                    <h3>AI ê²½ì˜ ì½”íŒŒì¼ëŸ¿</h3>
                </div>
                <!-- ì—¬ê¸°ì— ì‹¤ì‹œê°„ ë¶„ì„ í†µê³„ê°€ ìŒ“ì¼ ê³³ -->
                <div class="ai-insights" id="ai-insights-container">
                    <div class="insight-item">
                        <span class="insight-icon">ğŸ“ˆ</span>
                        <p>"ì˜¤ëŠ˜ ë–¡ë³¶ì´ ì£¼ë¬¸ì´ í‰ì†Œë³´ë‹¤ <strong>20%</strong> ë§ìŠµë‹ˆë‹¤. ì¬ê³ ë¥¼ í™•ì¸í•˜ì„¸ìš”!"</p>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ëŠ˜ì˜ ë§¤ì¶œ -->
            <div class="dashboard-card stats-card">
                <h3>ğŸ’° ì˜¤ëŠ˜ì˜ ë§¤ì¶œ</h3>
                <div class="stats-grid">
                    <div class="stat-item"><span id="total-sales" class="stat-value">â‚©487,000</span><span
                            class="stat-label">ì´ ë§¤ì¶œ</span></div>
                    <div class="stat-item"><span id="order-count" class="stat-value">47ê±´</span><span
                            class="stat-label">ì£¼ë¬¸ ìˆ˜</span></div>
                    <div class="stat-item"><span id="avg-price" class="stat-value">â‚©10,361</span><span
                            class="stat-label">ê°ë‹¨ê°€</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
    <div id="toast" class="notification-toast">
        <span style="font-size: 1.5rem">ğŸ””</span>
        <div>
            <h4 style="margin:0">ìƒˆ ì£¼ë¬¸ ë„ì°©!</h4>
            <p style="margin:0; font-size:0.9rem; opacity:0.9">í…Œì´ë¸” 3ë²ˆì—ì„œ ì£¼ë¬¸ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- QR ëª¨ë‹¬ -->
    <div id="qr-modal" class="hidden">
        <div class="qr-card">
            <h3>ğŸ“± í…Œì´ë¸” QR ìƒì„±</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:12px;">í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ë©´ ê³ ìœ  QRì´ ìƒì„±ë©ë‹ˆë‹¤</p>

            <div class="table-btn-group">
                <button class="table-btn active" onclick="generateQr(1, this)">1ë²ˆ</button>
                <button class="table-btn" onclick="generateQr(2, this)">2ë²ˆ</button>
                <button class="table-btn" onclick="generateQr(3, this)">3ë²ˆ</button>
                <button class="table-btn" onclick="generateQr(4, this)">4ë²ˆ</button>
            </div>

            <div id="qrcode" style="margin:20px auto; display:flex; justify-content:center;"></div>

            <p id="store-link" style="font-size:0.7rem; color:#aaa; word-break:break-all; display:none;"></p>
            <button onclick="closeQrModal()"
                style="background:#333; color:white; border:none; padding:10px 20px; border-radius:8px; width:100%;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        let totalSales = 487000;
        let totalOrders = 47;
        let peer = null;
        let myPeerId = null;

        // 1. BroadcastChannel (ë¡œì»¬ìš©)
        const bc = new BroadcastChannel('qtable_demo');
        bc.onmessage = (event) => processData(event.data);

        // 2. PeerJS (ì›ê²©ìš©)
        function initPeer() {
            // ëœë¤ ID ìƒì„±
            const id = 'qtable-store-' + Math.floor(Math.random() * 10000);
            peer = new Peer(id);

            peer.on('open', (id) => {
                myPeerId = id;
                console.log('My peer ID is: ' + id);
            });

            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    console.log('Received remote data:', data);
                    processData(data);
                });
                setTimeout(() => conn.send({ type: 'WELCOME', msg: 'í™˜ì˜í•©ë‹ˆë‹¤! ì£¼ë¬¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.' }), 500);
            });

            peer.on('error', (err) => console.log('Peer error:', err));
        }

        // ê³µí†µ ë°ì´í„° ì²˜ë¦¬
        function processData(payload) {
            if (payload.type === 'NEW_ORDER') {
                handleNewOrder(payload.data);
            } else if (payload.type === 'REVIEW_VERIFIED') {
                handleReviewVerified(payload.data);
            }
        }

        function showQrModal() {
            document.getElementById('qr-modal').classList.remove('hidden');
            // ê¸°ë³¸ 1ë²ˆ í…Œì´ë¸” ìƒì„±
            generateQr(1, document.querySelector('.table-btn'));
        }

        function generateQr(tableNum, btn) {
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼
            document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';

            // URLì— store IDì™€ table ë²ˆí˜¸ í¬í•¨
            const baseUrl = window.location.origin + window.location.pathname.replace('owner.html', 'customer.html');
            // searchParamsë¥¼ ì´ìš©í•´ ì•ˆì „í•˜ê²Œ êµ¬ì„±
            const fullUrl = `${baseUrl}?store=${myPeerId}&table=${tableNum}`;

            new QRCode(qrContainer, {
                text: fullUrl,
                width: 180,
                height: 180
            });

            const linkText = document.getElementById('store-link');
            linkText.textContent = fullUrl;
            linkText.style.display = 'block';
        }

        // ì´ˆê¸° ì‹¤í–‰
        try {
            initPeer();
        } catch (e) { console.error('Peer init failed', e); }

        function closeQrModal() {
            document.getElementById('qr-modal').classList.add('hidden');
        }

        function handleNewOrder(data) {
            try { new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(e => { }); } catch (e) { }

            // í…Œì´ë¸” ë²ˆí˜¸ í™•ì¸ ('Takeout' ë“± ê¸°ë³¸ê°’ ì²˜ë¦¬)
            const tableDisplay = data.tableNumber ? `í…Œì´ë¸” ${data.tableNumber}ë²ˆ` : 'í¬ì¥/ëŒ€ê¸°';

            showToast('ğŸ”” ìƒˆ ì£¼ë¬¸ ë„ì°©!', `${tableDisplay}ì—ì„œ ì£¼ë¬¸ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤`, '#FF6B35');

            const container = document.getElementById('order-list');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            // ì‚¬ìš©ì ì •ë³´ ë¶„ì„
            const userInfo = data.userInfo || { gender: 'unknown', age: 'unknown' };
            const userTag = (userInfo.gender !== 'unknown')
                ? `<span class="user-tag">ğŸ‘¤ ${userInfo.age}ëŒ€ ${userInfo.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}</span>`
                : '';

            // ì¬ë°©ë¬¸ ì—¬ë¶€
            const revisitTag = (userInfo.isRevisit)
                ? `<span class="user-tag" style="color:#03C75A; background:rgba(3,199,90,0.1); border:1px solid #03C75A;">â­ ì¬ë°©ë¬¸</span>`
                : '';

            // AI ì¸ì‚¬ì´íŠ¸ ìƒì„±
            const aiInsight = generateAiInsight(userInfo, data.items);

            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            orderCard.innerHTML = `
                <div class="order-header">
                    <span style="font-size:1.1rem; font-weight:bold; color:white;">${tableDisplay}</span>
                    <span>ë°©ê¸ˆ ì „</span>
                </div>
                <div class="order-header" style="margin-top:-4px; margin-bottom:12px;">
                     <span style="font-size:0.8rem; color:#888;">ì£¼ë¬¸ë²ˆí˜¸ ${data.orderNumber} ${userTag} ${revisitTag}</span>
                </div>
                <div class="order-items">
                    ${data.items.map(item => `${item.name} x${item.quantity}`).join(', ')}
                </div>
                <!-- AI ë¶„ì„ ê²°ê³¼ í‘œì‹œ (ì½”íŒŒì¼ëŸ¿) -->
                <div class="ai-insight-box">
                    <span>ğŸ¤–</span>
                    <div>
                        <strong>AI ì½”íŒŒì¼ëŸ¿ ë¶„ì„</strong><br>
                        ${aiInsight}
                    </div>
                </div>
                <div class="order-footer" style="margin-top:10px;">
                    <span class="order-price">â‚©${data.total.toLocaleString()}</span>
                    <div>
                        <button class="btn btn-sm btn-accept" style="background:var(--success); color:white; border:none; padding:4px 8px; border-radius:4px; font-weight:bold;" onclick="this.parentElement.innerHTML='ì ‘ìˆ˜ë¨'">ì ‘ìˆ˜ì™„ë£Œ</button>
                    </div>
                </div>
            `;
            container.prepend(orderCard);

            totalSales += data.total;
            totalOrders += 1;
            animateValue(document.getElementById('total-sales'), totalSales - data.total, totalSales, 1000);
            document.getElementById('order-count').textContent = totalOrders + 'ê±´';
            document.getElementById('avg-price').textContent = 'â‚©' + Math.floor(totalSales / totalOrders).toLocaleString();
        }

        function generateAiInsight(user, items) {
            // ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ AI ì‹œë®¬ë ˆì´ì…˜
            if (user.gender === 'unknown') return "ê³ ê° ë°ì´í„° ë¯¸ìˆ˜ì§‘. ì¼ë°˜ ì‘ëŒ€ ê¶Œì¥.";

            const isSpicy = items.some(i => i.name.includes('ë–¡ë³¶ì´') || i.name.includes('ë¼ë©´') || i.name.includes('ì œìœ¡'));
            const isAlcohol = items.some(i => i.name.includes('ë§¥ì£¼') || i.name.includes('ì†Œì£¼'));

            if (user.age === '20' && user.gender === 'female') {
                if (isSpicy) return "20ëŒ€ ì—¬ì„± ê³ ê°ì€ ë§¤ìš´ë§› ì¬êµ¬ë§¤ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤. <strong>ì¿¨í”¼ìŠ¤ ì„œë¹„ìŠ¤</strong>ë¡œ ë‹¨ê³¨ ìœ ì¹˜í•˜ì„¸ìš”!";
                return "SNS ë¦¬ë·° ì°¸ì—¬ìœ¨ì´ ë†’ì€ ê³ ê°êµ°ì…ë‹ˆë‹¤. <strong>ì˜ìˆ˜ì¦ ë¦¬ë·° ì´ë²¤íŠ¸</strong>ë¥¼ ì ê·¹ ê¶Œí•˜ì„¸ìš”.";
            }
            if (user.age === '20' && user.gender === 'male') {
                return "ì–‘ ë§ì€ ë©”ë‰´ë¥¼ ì„ í˜¸í•˜ëŠ” 20ëŒ€ ë‚¨ì„±ì…ë‹ˆë‹¤. <strong>ê³µê¸°ë°¥ ì¶”ê°€</strong> ì—¬ë¶€ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”.";
            }
            if (user.age === '30') {
                if (isAlcohol) return "30ëŒ€ ì§ì¥ì¸ íšŒì‹ ì¶”ì •. <strong>ì•ˆì£¼ë¥˜ ì¶”ê°€ ì£¼ë¬¸</strong> ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.";
                return "ì ì‹¬ì‹œê°„ ë°©ë¬¸ 30ëŒ€ì…ë‹ˆë‹¤. <strong>ë¹ ë¥¸ ì„œë¹™</strong>ì´ ë§Œì¡±ë„ì˜ í•µì‹¬ì…ë‹ˆë‹¤.";
            }
            if (user.age === '40') {
                return "ê°€ì¡± ë‹¨ìœ„ ë°©ë¬¸ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. <strong>ì•„ì´ë“¤ ì‹ê¸°</strong>ê°€ í•„ìš”í•œì§€ ì²´í¬í•˜ì„¸ìš”.";
            }

            return `${user.age}ëŒ€ ${user.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'} ê³ ê° ë°©ë¬¸. ${items[0].name} ë©”ë‰´ ì„ í˜¸ë„ ìƒìŠ¹ ì¤‘.`;
        }

        function handleReviewVerified(data) {
            try { new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3').play().catch(e => { }); } catch (e) { }

            const tableMsg = data.tableNumber ? `[í…Œì´ë¸” ${data.tableNumber}]` : '';
            showToast('ğŸ‰ ë¦¬ë·° ì¸ì¦ ìš”ì²­!', `${tableMsg} ì†ë‹˜ì´ ë¦¬ë·°ë¥¼ ì¼ìŠµë‹ˆë‹¤!`, '#03C75A');

            const container = document.getElementById('order-list');
            const reviewCard = document.createElement('div');
            reviewCard.className = 'order-card';
            reviewCard.style.cssText = "border-left: 4px solid #03C75A; background: rgba(3, 199, 90, 0.1);";
            reviewCard.innerHTML = `
                <div class="order-header" style="color:#03C75A; font-weight:bold;">
                    <span>ğŸ’ ë¦¬ë·° ì´ë²¤íŠ¸ ì¸ì¦</span>
                    <span>ë°©ê¸ˆ ì „</span>
                </div>
                <div class="order-items" style="color:white;">
                    ${tableMsg} ì£¼ë¬¸ë²ˆí˜¸ <strong>${data.orderNumber}</strong>
                </div>
                <div class="order-footer">
                    <span style="color:#aaa; font-size:0.8rem;">ì„œë¹„ìŠ¤ ìŒë£Œ ì œê³µ í•„ìš”</span>
                    <button class="btn btn-sm" style="background:#03C75A; color:white; border:none; padding:4px 12px; border-radius:4px; font-weight:bold;" onclick="this.parentElement.innerHTML='í™•ì¸ ì™„ë£Œ'">ì„œë¹„ìŠ¤ ì œê³µí•¨</button>
                </div>
            `;
            container.prepend(reviewCard);
        }

        function showToast(title, msg, color) {
            const toast = document.getElementById('toast');
            toast.style.background = color || '#FF6B35';
            toast.querySelector('h4').textContent = title;
            toast.querySelector('p').textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 5000);
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = 'â‚©' + Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>

</html>